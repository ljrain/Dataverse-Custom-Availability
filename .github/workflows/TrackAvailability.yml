name: Get Recent Artifact

on:
  workflow_dispatch: # Allows manual triggering

jobs:
  get-recent-artifact:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Dynamically Get Artifact Info
      - shell: pwsh
        run: |
          $wfId = "13771121330"
          $url = "https://api.github.com/repos/ljrain/DataverseAppInsightsTrackAvailability/actions/workflows/$wfId/runs"
          Write-Host $url
          $runs = curl -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ github.token }}" -H "X-GitHub-Api-Version: 2022-11-28" $url
          Write-Host "$runs"
          $runsObj = $runs | ConvertFrom-Json
          Write-Host "$runsObj and $($runsObj.GetType()) and $($runsObj.workflow_runs)"
          #Get the most recent run - GH api defaults list sorted reverse chronologically (index 0)
          $wfRunId = $runsObj.workflow_runs[0].id
          $artifactUrl = $runsObj.workflow_runs[0].artifacts_url
          $artifacts = curl -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ github.token }}" -H "X-GitHub-Api-Version: 2022-11-28" "$artifactUrl"
          $artifactsObj = $artifacts | ConvertFrom-Json
          $artifactName = $artifactsObj.artifacts[0].name
          Write-Host "adding artifact name and wfRun id to env vars $artifactName for run $wfRunId"
          echo "ARTIFACT_NAME=$artifactName" >> $env:GITHUB_ENV
          echo "RUN_ID=$wfRunId" >> $env:GITHUB_ENV

    # https://github.com/ljrain/DataverseAppInsightsTrackAvailability/actions/runs/13769377136/workflow
    # https://github.com/ljrain/DataverseAppInsightsTrackAvailability/actions/runs/13769377136
    ## 13771121330

    
